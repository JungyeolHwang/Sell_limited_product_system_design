그럼 마트 전광판 + 방송 안내판 비유로,
재고 처리(1~5번)랑 이벤트 발송(6번) 흐름을 한 번에 보여줄게요.

🛒 비유: 한정판 과자 판매 마트

재고 창고 = inventory 테이블

예약 명단 = reservation_hold 테이블

감사일지 = inventory_ledger 테이블

방송 안내판 = outbox 테이블

1~5번: 재고 처리 (트랜잭션 T1 내부)
손님: "과자 1개 주세요!" (sku=123, qty=1, 멱등키=abcd-123)

1) 멱등성 체크
   → 같은 멱등키로 이미 주문한 기록 있으면 거절 (동일 결제 재시도 방지)

2) 1인 1개 제한
   → 예약 명단에서 이 사람 이름 있으면 거절
     (한 사람이 여러 탭에서 동시에 주문 불가)

3) 재고 조건부 차감
   → 창고에서 "남은 수량 >= 1"이면 1개 빼기
     (조건부 UPDATE로 동시성 보장)

4) 예약 명단에 추가
   → reservation_hold에 'HOLD' 상태 + 만료시간 기록
     (TTL 지나면 자동 취소)

5) 감사일지 기록
   → inventory_ledger에 "누가, 언제, 몇 개 가져갔는지" 남김

6번: 이벤트 발송 준비 (같은 트랜잭션에서)
6) 방송 안내판(outbox)에 공지 등록
   → "sku=123, qty=1 예약됨" 이라는 메시지를 적음
   → 이건 창고 처리랑 같이 커밋되므로 절대 빠지지 않음

커밋 후

DB 트랜잭션이 성공적으로 끝나면
방송 안내판을 읽는 "아나운서(이벤트 발송 서비스)" 가
outbox에 적힌 메시지를 보고
→ 결제 시스템, 배송 시스템, 알림 시스템 등으로 전달

📌 왜 방송 안내판(outbox)이 필요하냐?

창고 명단(orders나 reservation_hold)만 보고 방송하면:

유실: 경계 시간 때문에 일부 주문은 방송 안 됨

중복: 같은 주문이 여러 번 방송될 수 있음

방송 안내판은 이벤트 발송만 전담하므로
중복·유실 없이 안전하게 전달 가능