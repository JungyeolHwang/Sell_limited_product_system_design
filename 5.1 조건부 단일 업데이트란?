조건부 단일 업데이트는 말 그대로

“재고가 충분할 때만 줄인다”를 한 SQL 문장에서 끝내는 방식

이에요.
읽고 → 판단하고 → 줄이는 걸 따로따로 하지 않고,
조건 검사와 재고 감소를 한 번에 처리하는 겁니다.

예시: 잘못된(두 단계) 방식
-- 1단계: 재고 읽기
SELECT available FROM inventory_counter WHERE sku_id = 101;

-- 2단계: 조건 검사 후 재고 줄이기
UPDATE inventory_counter SET available = available - 1 WHERE sku_id = 101;


이렇게 하면 두 트랜잭션이 동시에 재고를 읽고,
둘 다 “재고 있음”이라고 판단한 뒤 둘 다 깎아버리는 상황이 생깁니다.
(→ 초과 주문 발생, race condition)

올바른 “조건부 단일 UPDATE” 방식
UPDATE inventory_counter
SET available = available - 1
WHERE sku_id = 101
  AND available >= 1;


available >= 1 조건이 같은 문장에 포함됨

이 한 문장은 InnoDB에서 실행될 때 해당 행에 단일 행 락을 걸고 실행되기 때문에,
동시 요청이 들어와도 선착순 1개만 성공

실행 후 ROW_COUNT()가:

1이면 재고 차감 성공

0이면 재고 부족 → 품절 처리

핵심 특징

한 번의 UPDATE로 조건 확인 + 재고 감소 → 안전하고 빠름

별도의 SELECT … FOR UPDATE 없이도 초과주문 방지 가능

행 락을 잡는 시간이 짧아서 TPS가 높음

MySQL/InnoDB, PostgreSQL 모두 지원 (조건식만 조금 차이날 수 있음)

면접 답변 포맷

“조건부 단일 업데이트란, 재고 수량이 충분할 때만 감소시키는 UPDATE를 한 번에 실행하는 방식입니다. 예를 들어 UPDATE … WHERE available >= qty처럼 조건과 감소를 결합하면, 동시성 환경에서도 초과주문 없이 원자적으로 재고를 차감할 수 있습니다.”